{{/*
Shortcode: streamlit
Usage:
	{{< streamlit >}}
	{{< streamlit url="https://keynesianbeautycontest.streamlit.app" height="600" >}}
	{{< streamlit full="true" >}}
If `url` is omitted, the shortcode falls back to `.Site.Params.beautyContest.streamlitUrl`.
*/}}
{{ $url := (.Get "url") | default .Site.Params.beautyContest.streamlitUrl }}
{{ $height := (.Get "height") | default .Site.Params.beautyContest.iframeHeight }}
{{ $full := (.Get "full") | default "false" }}
{{ if eq (lower $full) "true" }}
<style>
	.streamlit-overlay {
		position: fixed;
		inset: 0;
		z-index: 9999;
		background: #fff;
		display: flex;
		flex-direction: column;
	}

	.streamlit-overlay .sc-close {
		position: absolute;
		top: 0.5rem;
		right: 0.5rem;
		z-index: 10000;
		background: #111;
		color: #fff;
		padding: 0.4rem 0.6rem;
		border-radius: 4px;
		text-decoration: none;
		font-size: 0.875rem;
	}

	.streamlit-overlay iframe {
		flex: 1;
		border: 0;
		width: 100%;
		height: 100%;
	}

	body.hugo-streamlit-open {
		overflow: hidden;
		height: 100vh;
	}
</style>
<div id="streamlit-overlay" class="streamlit-overlay">
	<a class="sc-close" href="#" onclick="closeStreamlitOverlay();return false;">Close</a>
	<div class="sc-fallback" style="display:none;padding:1rem;text-align:center;">
		<p style="margin:.5rem 0">Embedding failed or is blocked (redirect/auth or frame restrictions).</p>
		<a class="sc-open" href="{{ $url }}" target="_blank" rel="noopener" style="display:inline-block;padding:.5rem 0.75rem;background:#111;color:#fff;border-radius:4px;text-decoration:none">Open in new tab</a>
	</div>
	<iframe id="streamlit-iframe" src="{{ $url }}" loading="lazy" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
</div>
<script>
document.body.classList.add('hugo-streamlit-open');
function closeStreamlitOverlay(){
	const el=document.getElementById('streamlit-overlay');
	if(el) el.style.display='none';
	document.body.classList.remove('hugo-streamlit-open');
}
// ESC to close
document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeStreamlitOverlay(); });
// Fallback detection: if iframe doesn't fire load within timeout, show fallback
(function(){
	const iframe = document.getElementById('streamlit-iframe');
	const fallback = document.querySelector('#streamlit-overlay .sc-fallback');
	let loaded=false;
	const timeoutMs = 6000;
	function showFallback(){ if(fallback) fallback.style.display='block'; }
	if(!iframe){ showFallback(); return; }
	iframe.addEventListener('load', function(){ loaded=true; if(fallback) fallback.style.display='none'; });
	window.setTimeout(function(){ if(!loaded) showFallback(); }, timeoutMs);
})();
</script>
{{ else }}
<div class="streamlit-embed" style="margin:0.5rem 0;">
	<iframe id="streamlit-iframe" src="{{ $url }}" height="{{ $height }}" style="width:100%;border:0;min-height:300px;" loading="lazy" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
	<div id="sc-inline-fallback" style="display:none;margin-top:.5rem;padding:.5rem;background:#f7f7f7;border-radius:6px;text-align:center;">
		<div>Embedding may be blocked (redirects/auth or frame restrictions).</div>
		<a href="{{ $url }}" target="_blank" rel="noopener" style="display:inline-block;margin-top:.5rem;padding:.4rem .6rem;background:#111;color:#fff;border-radius:4px;text-decoration:none">Open in new tab</a>
	</div>
	<script>
		(function(){
			const iframe = document.getElementById('streamlit-iframe');
			const fallback = document.getElementById('sc-inline-fallback');
			let loaded=false;
			const timeoutMs=6000;
			iframe.addEventListener('load', function(){ loaded=true; if(fallback) fallback.style.display='none'; });
			window.setTimeout(function(){ if(!loaded && fallback) fallback.style.display='block'; }, timeoutMs);
		})();
	</script>
</div>
{{ end }}
